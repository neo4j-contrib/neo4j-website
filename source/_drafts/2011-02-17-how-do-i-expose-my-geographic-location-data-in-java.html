---
layout: post
title: "How do I expose my geographic location data in Java"
date: 2011-02-17
comments: false
categories:
 - neo4j spatial gis graph graphdatabase database geometry
---

<div class='post'>
<div class="separator" style="clear: both; float: right; text-align: center;"><a href="http://1.bp.blogspot.com/-VJ7Od2IjWV4/TV1ApDkNQ_I/AAAAAAAAA_Y/WbxDah-jvgo/s1600/Craig_square_small.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-VJ7Od2IjWV4/TV1ApDkNQ_I/AAAAAAAAA_Y/WbxDah-jvgo/s1600/Craig_square_small.JPG" /></a></div>It's increasingly common that geographical data is mixed in with other lines of business information to create compelling and useful systems. Processing and making use of that has previously been a tricky affair, but with the advent of graph databases, things are starting to look up for developers who want to enrich systems with geographical capabilities.<br /><br />The <a href="http://components.neo4j.org/neo4j-spatial/"><b><i>Neo4j Spatial</i></b></a> project provides the ability to operate on any existing data model. If you have a graph in Neo4j that contains spatial information, and you want to enable more powerful geographic analyses on your data, it is possible to enable it <i>without</i> having to restructure your graph. This is achieved by writing a small adapter that explains to <i>Neo4j Spatial</i> how to interpret your data model in a spatial way. It does not matter if your spatial data is stored as properties of nodes, properties of relationships, or entire sub-graphs. As long as your adapter can convert it, you can use Neo4j Spatial.<br /><br />So, let's explain how this works from the top down. In this post we will show you a very simple example, point location data stored as properties of a node and explain how to activate this on your own data model. In a related post we will delve deeper into the code that was written to support this, so you can write your own adapters.<br /><h4>Adding data</h4>So, I have an existing database where some nodes have the properties <i><b>lat</b></i> and <i><b>lon</b></i> which are of type double and contain, unsurprisingly, the latitude and longitude of some points of interest.<br /><br />The code required to iterate through this and add the points to the index in <i>Neo4j Spatial </i>would look like:<br /><pre class="brush: java">for(Node node: spatialNodes) {<br />    layer.getIndex().add(node);<br />}<br /></pre>Wow! That was too simple. Obviously we have left out a few important steps. Where did we get <b><i>spatialNodes</i></b> and <b><i>layer</i></b>&nbsp;from? Well, the first is a traverser that you need to write that will return all nodes that have the required <b><i>lat</i></b> and <b><i>lon</i></b> properties. The second is a reference to a <b><i>Layer</i></b> which you must initialize with the knowledge of your adapter. So, let's add the code to initialize this properly.<br /><h4>Configuring the layer</h4><pre class="brush: java">SpatialDatabaseService = new SpatialDatabaseService(new EmbeddedGraphDatabase("db"));<br />EditableLayer layer = (EditableLayer) db.createLayer(<br />    "my layer",<br />    SimplePointEncoder.class,<br />    EditableLayerImpl.class,<br />    "lon:lat");<br />for(Node node: spatialNodes) {<br />    layer.getIndex().add(node);<br />}<br /></pre>The first line creates the database the usual way, but then also wraps it in a <b><i><a href="https://github.com/neo4j/neo4j-spatial/blob/master/src/main/java/org/neo4j/gis/spatial/SpatialDatabaseService.java">SpatialDatabaseService</a></i></b> instance which provides the primary entry point into working with <i>Neo4j Spatial</i>. The next line creates a new, empty layer in the database, called 'my layer', using the <b><i><a href="https://github.com/neo4j/neo4j-spatial/blob/master/src/main/java/org/neo4j/gis/spatial/encoders/SimplePointEncoder.java">SimplePointEncoder</a></i></b> to describe how to convert the nodes into spatial objects, called 'Geometries', and the <b><i><a href="https://github.com/neo4j/neo4j-spatial/blob/master/src/main/java/org/neo4j/gis/spatial/EditableLayerImpl.java">EditableLayerImpl</a></i></b> class which allows this layer to be accessible as an editable layer, so you can add, remove and modify geometry nodes.<br /><br />That was a lot to swallow in one go, so I think we need to delve a little deeper into the way <i>Neo4j Spatial</i> supports layers to explain these concepts further.<br /><br />The simplest view of what a layer is can be seen in the interface <b><i><a href="https://github.com/neo4j/neo4j-spatial/blob/master/src/main/java/org/neo4j/gis/spatial/Layer.java">Layer</a></i></b>. This defines a layer as containing a collection of nodes, each of which represents a single <b><i>Geometry</i></b>, in this case a <b><i>Point</i></b> or location on the map. <i>Neo4j Spatial</i> supports far more complex geometries than mere points, but these will be dealt with in another post. For this example, each node simply describes one point on the map.<br /><br />Layer's also provides an API for accessing the spatial coordinate system, or projection, the type of geometries stored in the layer and most importantly the <b><i><a href="https://github.com/neo4j/neo4j-spatial/blob/master/src/main/java/org/neo4j/gis/spatial/GeometryEncoder.java">GeometryEncoder</a></i></b> used to map the graph to spatial objects. Look back at the <b><i>createLayer</i></b> method in the code above. We passed it the class <b><i>SimplePointEncoder</i></b> and the string "lon:lat". This string is stored as meta-data in the node representing the layer. Whenever <i>Neo4j Spatial</i> loads this layer, it does so by reading the properties of the layer node, initializing an instance of the <b><i>GeometryEncoder</i></b> specified and passing it any configuration parameters found, in this case the "lat:lon" string above. The encoder we used here, <b><i>SimplePointEncoder</i></b>, expects to be told the names of the properties of the geometry nodes to use for storing the location of the Point. Voila, now Neo4j Spatial is able to convert back and forth between <b><i>Point</i></b> and <b><i>Node</i></b> instances.<br /><br />At the beginning I said you need to write your own <b><i>GeometryEncoder</i></b>. Well, obviously that is only true if you find that none of the encoders included with <i>Neo4j Spatial</i> already do what you need. In this example, we did not need to write our own. If you have data that does not match the example we used here, we recommend that you review the encoders in the <b><i><a href="https://github.com/neo4j/neo4j-spatial/tree/master/src/main/java/org/neo4j/gis/spatial/encoders">org.neo4j.gis.spatial.encoders</a></i></b> package to see if any suite your needs. In addition we have another blog post that delves deeper into the various <b><i>GeometryEncoders</i></b> available, as well as describes how to write your own. Take a look, it is surprisingly simple.<br /><h4>Using Neo4j Spatial</h4>So, now you have your data spatially enabled. You are able to convert your nodes to <b><i>Point</i></b>&nbsp;geometries and use well known GIS libraries like Geotools and JTS to operate on these geometries. You can display the layer in a desktop GIS like uDig or a web-based GIS like GeoServer. See the wiki pages <a href="http://wiki.neo4j.org/content/Neo4j_Spatial_in_uDig">Neo4j Spatial in uDig</a> and <a href="http://wiki.neo4j.org/content/Neo4j_Spatial_in_GeoServer">Neo4j Spatial in GeoServer</a> for details on how to do that.<br /><br />But what about writing some Java code to perform spatial operations? Well the options are so wide that you need to learn the Geotools and JTS libraries to cover them all. But let's run through one small example, for which there is sample code in the test suite. Take a look at the class <b><i><a href="https://github.com/neo4j/neo4j-spatial/blob/master/src/test/java/org/neo4j/gis/spatial/LayersTest.java">LayersTest</a></i></b>, and the method <b><i>testPointLayer</i></b>. You will see that it initializes a layer using the same&nbsp;<b><i><a href="https://github.com/neo4j/neo4j-spatial/blob/master/src/main/java/org/neo4j/gis/spatial/encoders/SimplePointEncoder.java">SimplePointEncoder</a></i></b> adds some <b><i>Point</i></b> data to it and then proceeds to perform a search on the data.<br /><br /><pre class="brush: java">SpatialDatabaseService db = new SpatialDatabaseService( graphDb() );<br />EditableLayer layer = (EditableLayer) db.createLayer("test",</pre><pre class="brush: java">SimplePointEncoder.class, EditableLayerImpl.class, "lon:lat");<br />SpatialDatabaseRecord record = layer.add(</pre><pre class="brush: java">layer.getGeometryFactory().createPoint( new Coordinate( 15.3, 56.2 ) ) );<br />// finds geometries that contain the given search geometry<br />SearchContain searchQuery = new SearchContain(<br />    layer.getGeometryFactory().toGeometry(<br />    new Envelope( 15.0, 16.0, 56.0, 57.0 ) ) );<br />layer.getIndex().executeSearch( searchQuery );<br />List&lt;SpatialDatabaseRecord&gt; results = searchQuery.getResults();<br />// the result is empty because the Point does not contain the search Polygon<br />assertEquals( 0, results.size() );<br /><br />// finds geometries that contained within the given search geometry<br />SearchWithin withinQuery = new SearchWithin(<br />layer.getGeometryFactory().toGeometry(<br />    new Envelope( 15.0, 16.0, 56.0, 57.0 ) ) );<br />layer.getIndex().executeSearch( withinQuery );<br />results = withinQuery.getResults();<br />// the result set should contain the single point we put into the layer<br />assertEquals( 1, results.size() );</pre><br />The above code uses two of the several search classes provided with <i>Neo4j Spatial</i>, namely <b><i><a href="https://github.com/neo4j/neo4j-spatial/blob/master/src/main/java/org/neo4j/gis/spatial/query/SearchContain.java">SearchContain</a></i></b>&nbsp;and <b><i><a href="https://github.com/neo4j/neo4j-spatial/blob/master/src/main/java/org/neo4j/gis/spatial/query/SearchWithin.java">SearchWithin</a></i></b>. The second one you are likely to use more often. What it does is searches for all geometries contained within the search geometry, often a <b><i>Polygon</i></b> defining the search area. For more examples of this, take a look also at the code in other test cases, like the more complex <b><i><a href="https://github.com/neo4j/neo4j-spatial/blob/master/src/test/java/org/neo4j/gis/spatial/TestSpatial.java">TestSpatial</a></i></b> class that uses real 'Open Street Map' data to load the database and perform searches.<a href="https://github.com/neo4j/neo4j-spatial/tree/master/src/main/java/org/neo4j/gis/spatial/encoders">https://github.com/neo4j/neo4j-spatial/tree/master/src/main/java/org/neo4j/gis/spatial/encoders</a></div>
